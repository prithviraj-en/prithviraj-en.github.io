{"componentChunkName":"component---src-templates-post-template-js","path":"/fastapi-react-docker/","result":{"data":{"post":{"id":"7d5d2e96-a0f5-59e5-a2f7-c47f3c523e26","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8784cb962b0593b5efb51100b12ec2ed/4409e/christopher-gower-m_HRfLhgABo-unsplash.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAAD/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAWZHZZrDj//EABsQAQEAAQUAAAAAAAAAAAAAAAIDAAEEERIT/9oACAEBAAEFAhTrCdS1m219TOJCV+F//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGxAAAgIDAQAAAAAAAAAAAAAAAAECERASMWH/2gAIAQEABj8C9RSjWJQlwtDWiP/EABwQAAICAgMAAAAAAAAAAAAAAAERACExUUFhcf/aAAgBAQABPyETy0BjmHJ1LfseoomEthWzEBR3P//aAAwDAQACAAMAAAAQ+9//xAAVEQEBAAAAAAAAAAAAAAAAAAAQIf/aAAgBAwEBPxCn/8QAFREBAQAAAAAAAAAAAAAAAAAAECH/2gAIAQIBAT8Qh//EABoQAQEBAQEBAQAAAAAAAAAAAAERACExQfD/2gAIAQEAAT8QGW/Kh86uWhW1K3ABBA5iLmDRT957u+qGFAwSIp1d3//Z'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"unsplash.com\"\n        title=\"\"\n        src=\"/static/8784cb962b0593b5efb51100b12ec2ed/4b190/christopher-gower-m_HRfLhgABo-unsplash.jpg\"\n        srcset=\"/static/8784cb962b0593b5efb51100b12ec2ed/e07e9/christopher-gower-m_HRfLhgABo-unsplash.jpg 200w,\n/static/8784cb962b0593b5efb51100b12ec2ed/066f9/christopher-gower-m_HRfLhgABo-unsplash.jpg 400w,\n/static/8784cb962b0593b5efb51100b12ec2ed/4b190/christopher-gower-m_HRfLhgABo-unsplash.jpg 800w,\n/static/8784cb962b0593b5efb51100b12ec2ed/e5166/christopher-gower-m_HRfLhgABo-unsplash.jpg 1200w,\n/static/8784cb962b0593b5efb51100b12ec2ed/b17f8/christopher-gower-m_HRfLhgABo-unsplash.jpg 1600w,\n/static/8784cb962b0593b5efb51100b12ec2ed/4409e/christopher-gower-m_HRfLhgABo-unsplash.jpg 3882w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>I finally sat down to create a fully production ready API with a frontend. On the deploy side, <a href=\"https://www.docker.com/\">Docker</a> seems to be an awesome tool I should have learnt by now. With no dearth of time on my hands (no thanks to Covid), I completed the code over the weekend.</p>\n<h2>The Tech Stack</h2>\n<p>I decided to use something fancy this time. The API backend has been written in Python using <a href=\"https://fastapi.tiangolo.com/\">fastapi</a>. The frontend is a very simple <a href=\"https://en.wikipedia.org/wiki/Single-page_application\">single page application</a> written in <a href=\"https://reactjs.org/\">React JS</a>. The user data is stored on a <a href=\"https://www.postgresql.org/\">postgres</a> database. The deployment will be handled by <a href=\"https://docs.docker.com/compose/\">Docker-Compose</a>. The code is on Github <a href=\"https://github.com/petejadhav/ml_fastapi_react\">here</a>.</p>\n<h3>API Server Backend</h3>\n<p>The API server will be created in Python using fastapi.\nThe API should be able to handle the following functions -</p>\n<ul>\n<li>Login &#x26; User Registration </li>\n<li><a href=\"https://auth0.com/docs/tokens/json-web-tokens\">JSON-Web-Token</a> based authentication. Code is <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/backend/jwt_auth_handler.py\">here</a></li>\n<li>Writing &#x26; modifying user data on the database. Code is <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/backend/user_handler.py\">here</a></li>\n<li>API <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/backend/main.py\">endpoints</a> for general use (like exposing a Machine Learning model)</li>\n</ul>\n<p>The <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/backend/main.py\">main</a> file has the code that defines the endpoints. The user handler file will handle the database calls. The user password will be stored as a hash. This is handled by the <a href=\"https://en.wikipedia.org/wiki/Bcrypt\">bcrypt</a> algorithm.\nThe <strong>/login</strong> endpoint will expect a username &#x26; password and return a JWT token.</p>\n<p>The code will be deployed on a docker continer using the <strong><em><a href=\"https://hub.docker.com/r/tiangolo/uvicorn-gunicorn-fastapi/dockerfile\">uvicorn-gunicorn-fastapi</a></em></strong> image.</p>\n<h3>React JS Frontend</h3>\n<p>The single-page-application frontend will be developed in Javascript using React JS.\nThe frontend will have the following components -</p>\n<ul>\n<li>Routing using <a href=\"https://reactrouter.com/web/guides/quick-start\">React Router</a></li>\n<li>Login component</li>\n<li>Register component</li>\n<li>Example API endpoint handler component</li>\n<li>State management using <a href=\"https://recoiljs.org/\">Recoil</a>. (Recoil is kinda cool. Check it out.)</li>\n</ul>\n<p>The login, register &#x26; endpoint handler component will call the API we built earlier. The login &#x26; register component will POST request the API which will return the JSON Web token to make authenticated calls to the other endpoints.\nThe app <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/frontend/src/state.js\">state</a> is just an authentication flag &#x26; user data for now. The example handler will check the auth flag before calling our API.</p>\n<p>The frontend code will also be deployed on a docker container. We’ll use the basic <a href=\"https://www.nginx.com/\">Nginx</a> image. The react code will sit behind an nginx server. The nginx server will also handle the API requests at <strong>/api</strong> and redirect them to the API server. The nginx conf file is <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/frontend/nginx.conf\">here</a></p>\n<h3>Postgres Database</h3>\n<p>The user data will be stored on a Postgres database. For now, we will just store the user’s email and password. The easiest way to get postgres on your machine is to use a Docker image.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> postgres \n<span class=\"token keyword\">ENV</span> POSTGRES_PASSWORD postgres \n<span class=\"token keyword\">ENV</span> POSTGRES_DB testdb \n<span class=\"token keyword\">COPY</span> init.sql /docker<span class=\"token punctuation\">-</span>entrypoint<span class=\"token punctuation\">-</span>initdb.d/</code></pre></div>\n<p>This will get the original postgres image from <a href=\"https://hub.docker.com/\">docker-hub</a>. Create 2 environment variables for database name and password. The last line will copy a SQL script that will be executed on startup. Our startup script will just create an empty User table with the required schema.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>users <span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">SERIAL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n    email <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    password <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Run the docker container with the following commands in the directory that contains dockerfile.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker build -t pgdb <span class=\"token builtin class-name\">.</span>\ndocker run -d --name pgdb_container -p <span class=\"token number\">5432</span>:5432 pgdb</code></pre></div>\n<h3>Deploy using Docker Compose</h3>\n<p><a href=\"https://docs.docker.com/compose/\">Docker-Compose</a> is an awesome tool that can handle multiple container deployments on the same host. We are creating 3 different containers for the 3 services (api, web, db) which will run on the same host machine.\nAll we need is to create the docker-compose.yaml file.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.7\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> postgres_db\n        <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"CMD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pg_isready\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-q\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"${POSTGRES_DB}\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-U\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"postgres\"</span> <span class=\"token punctuation\">]</span>\n          <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 45s\n          <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n          <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    \n    <span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> frontend\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span>\n        <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> api\n\n    <span class=\"token key atrule\">api</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> backend\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> PORT=80\n          <span class=\"token punctuation\">-</span> DB_HOST=db\n        <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy</code></pre></div>\n<p>We define the <strong><em>healthcheck</em></strong> because we need the postgres databse to be up &#x26; running before the API server starts.</p>\n<p>Running this will start all 3 services -</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker-compose up --build</code></pre></div>\n<p>That’s all folks. You now have a production-ready API server with a simple frontend and a user database. Don’t forget to change the JWT secret in the backend <a href=\"https://github.com/petejadhav/ml_fastapi_react/blob/main/backend/config.py\">config</a> file.</p>","fields":{"slug":"/fastapi-react-docker/","prefix":"2021-05-26"},"frontmatter":{"title":"Develop & Deploy Fastapi + React with Postgres using Docker-Compose","author":"pete jadhav","category":"technology","cover":{"childImageSharp":{"resize":{"src":"/static/6be3f7ce6a0222c849a92cae01040678/9dc27/shahadat-rahman-BfrQnKBulYQ-unsplash.jpg"}}}}},"authornote":{"id":"3e92faab-4199-5666-89a7-6a21f581b459","html":"<p><strong>Pete Jadhav</strong> - To Infinity &#x26; Beyond</p>"},"site":{"siteMetadata":{"facebook":{"appId":""}}}},"pageContext":{"slug":"/fastapi-react-docker/","prev":{"id":"b1e2d8cb-d48d-5986-8a15-ba08b3f7af36","fields":{"slug":"/workout-timer/","prefix":"2020-07-22","source":"posts"},"frontmatter":{"title":"Cardio HIIT Timer App in React-Native","category":"technology"}},"source":"posts"}}}